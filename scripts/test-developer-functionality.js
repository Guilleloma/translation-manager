#!/usr/bin/env node

/**
 * Script de pruebas automatizadas para la funcionalidad del panel de developer
 * Valida la detecciÃ³n de slugs auto-generados, generaciÃ³n de sugerencias y prioridades
 */

// Importar las funciones desde el archivo de test-data
const path = require('path');

// Simular las funciones ya que no podemos importar TypeScript directamente
const isSlugAutoGenerated = (slug, text) => {
  const autoPatterns = [
    /^auto_/,
    /^text_\d+/,
    /\d{10,}/,  // timestamps
    /^[a-z]+_\d+$/,
    /^copy_\d+$/
  ];

  return autoPatterns.some(pattern => pattern.test(slug));
};

const generateSuggestedSlug = (text) => {
  return text
    .toLowerCase()
    .replace(/[Ã¡Ã Ã¤Ã¢]/g, 'a')
    .replace(/[Ã©Ã¨Ã«Ãª]/g, 'e')
    .replace(/[Ã­Ã¬Ã¯Ã®]/g, 'i')
    .replace(/[Ã³Ã²Ã¶Ã´]/g, 'o')
    .replace(/[ÃºÃ¹Ã¼Ã»]/g, 'u')
    .replace(/[Ã±]/g, 'n')
    .replace(/[^a-z0-9\s]/g, '')
    .trim()
    .split(/\s+/)
    .slice(0, 3)
    .join('_');
};

const determinePriority = (slug, text) => {
  // Alta prioridad: slugs con timestamps o muy genÃ©ricos
  if (/\d{10,}/.test(slug) || /^(auto_|text_|copy_)/.test(slug)) {
    return 'high';
  }
  
  // Media prioridad: textos largos con slugs simples
  if (text.length > 50 && /^[a-z]+_\d+$/.test(slug)) {
    return 'medium';
  }
  
  return 'low';
};

// Casos de prueba
const testCases = [
  {
    slug: 'auto_1234',
    text: 'Texto de prueba',
    expectedDetection: true,
    expectedPriority: 'high',
    description: 'Slug con prefijo auto_'
  },
  {
    slug: 'text_456',
    text: 'Otro texto',
    expectedDetection: true,
    expectedPriority: 'high',
    description: 'Slug con prefijo text_ y nÃºmero'
  },
  {
    slug: 'mensaje_1703875200000',
    text: 'Mensaje con timestamp',
    expectedDetection: true,
    expectedPriority: 'high',
    description: 'Slug con timestamp'
  },
  {
    slug: 'button.save',
    text: 'Guardar',
    expectedDetection: false,
    expectedPriority: 'low',
    description: 'Slug descriptivo vÃ¡lido'
  },
  {
    slug: 'error.validation',
    text: 'Error de validaciÃ³n',
    expectedDetection: false,
    expectedPriority: 'low',
    description: 'Slug con namespace vÃ¡lido'
  },
  {
    slug: 'welcome_message',
    text: 'Mensaje de bienvenida',
    expectedDetection: false,
    expectedPriority: 'low',
    description: 'Slug descriptivo sin nÃºmeros'
  },
  {
    slug: 'texto_123',
    text: 'Este es un texto muy largo que deberÃ­a tener prioridad media porque tiene mÃ¡s de cincuenta caracteres',
    expectedDetection: true,
    expectedPriority: 'medium',
    description: 'Texto largo con slug simple (prioridad media)'
  }
];

const suggestionTests = [
  {
    text: 'Bienvenido a nuestra aplicaciÃ³n',
    expected: 'bienvenido_a_nuestra'
  },
  {
    text: 'Guardar cambios',
    expected: 'guardar_cambios'
  },
  {
    text: 'Error de validaciÃ³n',
    expected: 'error_de_validacion'
  },
  {
    text: 'Usuario no encontrado',
    expected: 'usuario_no_encontrado'
  },
  {
    text: 'ConfiguraciÃ³n avanzada del sistema',
    expected: 'configuracion_avanzada_del'
  },
  {
    text: 'Ã‘oÃ±o JosÃ© MarÃ­a',
    expected: 'nono_jose_maria'
  },
  {
    text: 'Â¡Hola! Â¿CÃ³mo estÃ¡s?',
    expected: 'hola_como_estas'
  }
];

function runTests() {
  console.log('ğŸ§ª Ejecutando pruebas del Panel de Developer\n');

  let totalTests = 0;
  let passedTests = 0;

  // Test 1: DetecciÃ³n de slugs auto-generados
  console.log('ğŸ“‹ Test 1: DetecciÃ³n de slugs auto-generados');
  testCases.forEach((testCase, index) => {
    totalTests++;
    const result = isSlugAutoGenerated(testCase.slug, testCase.text);
    const passed = result === testCase.expectedDetection;
    
    console.log(`  ${passed ? 'âœ…' : 'âŒ'} Test ${index + 1}: ${testCase.description}`);
    console.log(`     Slug: "${testCase.slug}" â†’ ${result ? 'Auto-generado' : 'VÃ¡lido'}`);
    
    if (passed) {
      passedTests++;
    } else {
      console.log(`     âŒ Esperado: ${testCase.expectedDetection}, Obtenido: ${result}`);
    }
  });

  console.log(`\nğŸ“Š Resultado Test 1: ${passedTests}/${totalTests} pruebas de detecciÃ³n pasaron\n`);

  // Test 2: DeterminaciÃ³n de prioridades
  console.log('ğŸ“‹ Test 2: DeterminaciÃ³n de prioridades');
  const priorityTestsStart = totalTests;
  testCases.forEach((testCase, index) => {
    totalTests++;
    const result = determinePriority(testCase.slug, testCase.text);
    const passed = result === testCase.expectedPriority;
    
    console.log(`  ${passed ? 'âœ…' : 'âŒ'} Prioridad ${index + 1}: ${testCase.description}`);
    console.log(`     Prioridad: ${result} (esperada: ${testCase.expectedPriority})`);
    
    if (passed) {
      passedTests++;
    } else {
      console.log(`     âŒ Esperado: ${testCase.expectedPriority}, Obtenido: ${result}`);
    }
  });

  const priorityPassed = passedTests - (priorityTestsStart);
  const priorityTotal = totalTests - priorityTestsStart;
  console.log(`\nğŸ“Š Resultado Test 2: ${priorityPassed}/${priorityTotal} pruebas de prioridad pasaron\n`);

  // Test 3: GeneraciÃ³n de sugerencias
  console.log('ğŸ“‹ Test 3: GeneraciÃ³n de sugerencias de slug');
  const suggestionTestsStart = totalTests;
  suggestionTests.forEach((testCase, index) => {
    totalTests++;
    const result = generateSuggestedSlug(testCase.text);
    const passed = result === testCase.expected;
    
    console.log(`  ${passed ? 'âœ…' : 'âŒ'} Sugerencia ${index + 1}:`);
    console.log(`     Texto: "${testCase.text}"`);
    console.log(`     Sugerencia: "${result}"`);
    
    if (passed) {
      passedTests++;
    } else {
      console.log(`     âŒ Esperado: "${testCase.expected}", Obtenido: "${result}"`);
    }
  });

  const suggestionPassed = passedTests - suggestionTestsStart;
  const suggestionTotal = totalTests - suggestionTestsStart;
  console.log(`\nğŸ“Š Resultado Test 3: ${suggestionPassed}/${suggestionTotal} sugerencias correctas\n`);

  // Resumen final
  console.log('ğŸ¯ RESUMEN FINAL:');
  console.log(`   Total de pruebas: ${totalTests}`);
  console.log(`   Pruebas exitosas: ${passedTests}`);
  console.log(`   Tasa de Ã©xito: ${Math.round((passedTests / totalTests) * 100)}%`);

  // Desglose por categorÃ­a
  console.log('\nğŸ“ˆ Desglose por categorÃ­a:');
  console.log(`   DetecciÃ³n de slugs: ${passedTests >= testCases.length ? testCases.length : Math.min(passedTests, testCases.length)}/${testCases.length}`);
  console.log(`   Prioridades: ${priorityPassed}/${priorityTotal}`);
  console.log(`   Sugerencias: ${suggestionPassed}/${suggestionTotal}`);

  if (passedTests === totalTests) {
    console.log('\nğŸ‰ Â¡Todas las pruebas pasaron! El panel de developer estÃ¡ listo.');
    return true;
  } else {
    console.log('\nâš ï¸  Algunas pruebas fallaron. Revisar la implementaciÃ³n.');
    return false;
  }
}

// Ejecutar solo si se llama directamente
if (require.main === module) {
  const success = runTests();
  process.exit(success ? 0 : 1);
}

module.exports = { 
  runTests, 
  isSlugAutoGenerated, 
  generateSuggestedSlug, 
  determinePriority 
};
